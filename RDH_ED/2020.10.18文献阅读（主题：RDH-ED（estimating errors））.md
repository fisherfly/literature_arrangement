# 2020.10.18文献阅读（主题：RDH—ED（estimating errors））

> W.Zhang, K.Ma, N.Yu, ’’Reversibility improved data hiding in encrypted images,’’ signal processing, 94, 118-127, 2014.

## 腾出空间并加密图像

### 选取部分像素进行估计

首先秘密随机选取$p\%$个像素，并记为$I$，并通过该像素周围的的$1-p\%$个像素(记为$E$)估计所选取的像素。(通常$p$小于等于20。)估计所用的公式如下：
$$
\bold{X}’(i,j) = \Bigg \lfloor \frac{\sum^1_{h = -1} \sum^1_{w = -1} X(i+h,j+w) {\rm sgn}(\bold{X}(i+h,j+w))} {\sum^1_{h = -1} \sum^1_{w = -1} {\rm sgn} (\bold{X}(i+h,j+w))} \Bigg \rfloor
$$
其中sgn的含义是。如果这个像素属于$I$，则${\rm sgn}(X)$等于0，否则等于1。
需要注意的是，为了使估计的结果更加精确，设定阈值$T$使得只有周围像素数大于$T$(文中令$T=4$)的像素(记为$I_a$)可以被估计，而小于阈值的像素将不会被估计，且同$E$一起被加密。

### 计算估计误差并进行必要的标记

在计算估计值之后，可以计算估计值的误差：
$$
e(i,j) = \bold{X}(i,j)-\bold{X}'(i,j)
$$
令所得到的该像素的估计误差代替原属于$I_a$的像素值。用八位二进制比特的最高位代表差值的正负，另外七位表示$[-124,125]$的像素值。当误差结果不在这个区间内，将其通过+124或-125置入此区间内。同时使用位置标记1记录修改位置。

### 通过直方图平移创建隐藏空间

首先找出估计误差直方图上最高的两点（将其像素值记为$P_1$和$P_2$，一般情况下，其服从拉普拉斯分布，即分别为-1和1）。

其次找出估计误差直方图上最低的两点，将其像素值记为$Z_1$和$Z_2$，且满足$Z_1<P_1$和$P_2<Z_2$。

直方图平移的过程可以表示为：
$$
e'(i,j) = 
\begin{cases}
e(i,j) + {\rm sgn}'(e(i,j)) \times 1 \quad \ {\rm if} \ e(i,j) \in (Z_1,-2] \cup [1,Z_2) \\
e(i,j) \qquad \qquad \qquad \qquad \quad otherwise
\end{cases}
$$
其中$e'(i,j)$代表平移后的估计误差。${\rm sgn}$可以表示如下：
$$
{\rm sgn}'(e(i,j)) = 
\begin{cases}
-1 \qquad \ {\rm where} \ e(i,j) \in [Z_1,-2] \\
1 \qquad \quad{\rm where} \ e(i,j) \in [Z_1,-2] 
\end{cases}
$$


以此腾出-2和1的空间。同时如果原来$Z_1$和$Z_2$上有值的话，需要进行位置标记2。

> 上述两个位置标记可以通过已有的RDH方案嵌入$E$区域中。

### 对于$I_a$的加密

在秘密信息持有者嵌入之前，可能会暴露$I_a$的分布。因此对其进行加密。

随机在$I_a$中选取q%个位置，记为$Ind$。如果$e'(i,j) \in [2,125]$，或者$e'(i,j) = 0$且$(i,j) \in Ind$，则生成一个伪随机数$r(i,j) \in [0,125]$进行加密：
$$
E_1(e'(i,j)) = (r(i,j) + e'(i,j) \mod 126) + 2
$$
此时加密过的像素值范围$[2,127]$

另一方面，如果$e'(i,j) \in [-124，-3]$，或者$e'(i,j) = -1$且$(i,j) \in Ind$，则生成一个伪随机数$r(i,j) \in [0,124]$进行加密：
$$
E_2(e'(i,j)) = -(r(i,j) - e'(i,j) \mod 125) - 3
$$
此时加密过的像素值范围$[-124,-3]$

由于有位置标记存在，这些数值可以被恢复。

这一步主要对全部的不包含秘密信息的平移后像素值和q%的0，-1进行加密，使得数值分布不会被发现。



### 秘密信息嵌入

剩余的0和-1位置将被嵌入信息。（前16位用于嵌入$I_a$的长度）嵌入公式如下：
$$
e''(i,j) = 
\begin{cases}
e'(i,j) + b \quad {\rm if} \ e'(i,j) = 0 \\
e'(i,j) - b \quad {\rm if} \ e'(i,j) = -1
\end{cases}
$$
则$b$可以按如下规则提取，且估计误差值$e'(i,j)$可以被恢复为：
$$
b = 
\begin{cases}
0 \quad {\rm if} \ e''(i,j) = 0 \ {\rm or} -1 \\
1 \quad {\rm if} \ e''(i,j) = 1 \ {\rm or} -2
\end{cases}
$$

$$
e'(i,j) = 
\begin{cases}
e''(i,j) \qquad \ \ \ {\rm if} \ e''(i,j) = 0 \ {\rm or} -1 \\
e''(i,j) - 1 \quad {\rm if} \ e''(i,j) = 1 \\
e''(i,j) + 1 \quad {\rm if} \ e''(i,j) = -2 \\
\end{cases}
$$

### 置乱

将整幅图像重新分配，使得$I_a$在图像最前端，后边接着$I_b$和$E$。这将保护图像的位置信息不被泄露。最后，内容的所有者使用加密密钥和`AES`算法对$I_b$和$E$进行加密。



## 加密图像中的秘密信息嵌入

秘密信息的持有者首先从前16像素中读取$I_a$长度。然后根据隐藏密钥加密待嵌入秘密信息。之后通过和先前一样的公式将秘密信息嵌入$I_a$中。最后根据信息隐藏密钥再次置乱图像，进一步抵御攻击。



## 信息提取和图像恢复

### 在图像解密之前的信息提取

接收者首先将图像置乱还原，并得到所有的$I_a$。之后通过公式还原出嵌入图像的加密后的秘密信息，并进行解密，得到所嵌入的秘密信息。此时接收者可以还原加密后的图像，或是嵌入新的秘密信息。



### 在信息提取之前的图像解密

#### 生成含有标记的加密图像

1. 通过隐藏密钥，接收方还原载体元素的置乱，读取$I_a$的长度，并对其进行解密。

   记加密过的预测误差为$E(e'(i,j))$。当$E(e'(i,j)) \in [2,127]$时，有
   $$
   e'(i,j) = E(e'(i,j)) - 2 - r(i,j) \mod 126
   $$
   当$E(e'(i,j)) \in [-127,-3]$时，按如下方式解密：
   $$
   e'(i,j) = -(E(e'(i,j)) - 3 - r(i,j) \mod 125)
   $$
   同时，$I_b$和$E$也进行加密。

2. 通过加密密钥生成p%个位置放置$I_a$，同时将$I_b$和$E$进行放置。

3. 从$E$中提取位置图，将对应位置的像素值还原出$[-124,125]$

4. 通过$I_a$周围的像素值计算该位置估计值，并和该位置的预测误差相加得到具有秘密信息的像素值$\bold{X}''(i,j)$。此处可能产生溢出（由于预测误差经过了修改。）记录溢出位置的图3，并将其通过传统RDH算法嵌入$E$中。

5. 用得到的$\bold{X}''(i,j)$替换$e'(i,j)$

此时从肉眼上已察觉不出含有秘密信息的图像（上边得到的）和原始图像的差距。

#### 秘密信息提取和图像还原

1. 在$E$中通过RDH算法提取三个位置图。

2. 定位所有的$I_a$，并计算其估计值。通过和该位置元素(包含秘密信息)相减，得到预测误差。对于位置图1中的元素，将其恢复到8位表示状态。对于位置图3中的元素，由于防溢出的修饰需要被还原。

3. 通过加密密钥生成$Ind$，其中包含q%的$I_a$。在除了$Ind$之外的的元素值为0或-1的位置进行解码。

4. 通过如下公式还原估计误差：
   $$
   e(i,j) = 
   \begin{cases}
   e'(i,j) - {\rm sgn}'(e'(i,j)) \times 1 \quad \ {\rm if} \ e'(i,j) \in (Z_1,-2] \cup [1,Z_2) \\
   e'(i,j) \qquad \qquad \qquad \qquad \quad otherwise
   \end{cases}
   $$
   

   同时通过第一个和第二个图还原原始的估计误差。

5. 通过估计值和还原出的误差可以还原出原始的像素值。

6. 用原始的像素值替换含有秘密信息的像素值即可恢复原始图像。